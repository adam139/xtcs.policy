<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"      
      i18n:domain="xtcs.policy">        
<head>
<metal:override fill-slot="top_slot"
    tal:define="disable_column_one python:request.set('disable_plone.leftcolumn',1);
                disable_column_two python:request.set('disable_plone.rightcolumn',1);"/>
</head>
<body>	
<metal:main fill-slot="main">
    <tal:main-macro metal:define-macro="main">
    <div id="juankuan_workflow"  
    	tal:attributes="data-ajax-base python:portal_url;data-ajax-auth python:'/@@hotauth'">
      <div class="jumbotron">
      	<div class="container">
      		<h3 class="text-center" style="color:#de0000">众志成城,齐心协力</h3>
      		<h1 tal:content="structure python:view.get_projects(22)['title']"></h1>
      		<h3 class="text-center" style="color:#df0000">万众一心,我要捐款</h3>		
		<div class="row">
			<!--选择支付方式,捐款项目,发起支付 -->
			<div class="col-xs-12">
			<form class="ajaxform">
				<input type="hidden" value="" name="openid">
				<input type="hidden" value="" name="code">
				  <div class="radio" style="display:none" 
				  	tal:content="structure python:view.get_projects(22)['html']">
				  </div>
			 <div class="form-group">
			 	<label for="InputName"><span class="required">捐款人</span></label>
					<input type="text" class="form-control" name="name" value="">
					<p></p>			 	
			 	<label for="InputMoney"><span class="required">捐款金额(单位:元)</span></label>
					<input type="text" class="form-control" name="money" value="">
			 </div>             	                          
			 <div class="form-group">
			 	<label for="InputWay">捐款方式</label>
				<div class="radio">
					<label><input type="radio" name="optionsPay" id="optionsPay1" value="pay1" checked="checked" />微信支付</label>
					<p></p>             			
					<label><input type="radio" name="optionsPay" id="optionsPay2" value="pay2" disabled />支付宝支付</label>
             	</div>					
			 </div>
			<div class="row">
			<div class="col-xs-6">
			<button id="submit" class="btn btn-warning btn-lg" name="ok">确定</button>
			</div>
			<div class="col-xs-6">
			<button class="btn btn-default btn-lg" name="cancel">取消</button>
			</div>
			</div>
			</form>            		
			</div>																		
		</div>		<!--end row -->
      	</div>	
      </div>		      
     </div>
  </tal:main-macro>
 </metal:main>

  <metal:js fill-slot="javascript_bottom_slot">
	<script type="text/javascript">
  function setCookie(cname,cvalue,exdays){
    var d = new Date();
    d.setTime(d.getTime()+(exdays*24*60*60*1000));
    var expires = "expires="+d.toGMTString();
    document.cookie = cname + "=" + cvalue + "; " + expires;
  }
function getCookie(cname){
   var name = cname + "=";
   var ca = document.cookie.split(';');
   for(var i=0; i<ca.length; i++){
     var c = ca[i].trim();
     if (c.indexOf(name)==0) return c.substring(name.length,c.length);
    }
    return "";
  }

function getUrlParams (url) {
  var urlParams = new Object();
  // eslint-disable-next-line eqeqeq
  if (url.indexOf('?') != -1) {
      var str = url.substr(1);
      var strs = str.split('&');
      for (var i = 0; i < strs.length; i++) {
        urlParams[strs[i].split('=')[0]] = unescape(strs[i].split('=')[1]);
      }
    }
    return urlParams;
  }
function isEmpty (obj) {
  if (obj === null) return true;
  if (typeof obj === 'undefined') {
    return true;
  }
  if (typeof obj === 'string') {
    if (obj === '') {
      return true;
    }
    var reg = new RegExp('^([ ]+)|([　]+)$');
    return reg.test(obj);
  }
  return false;
  }
function init(authurl,base) {
  var url = decodeURIComponent(location.search);
  var params = Object.assign(getUrlParams(url));
  if (isEmpty(params.code)&& isEmpty(params.openid)){
    window.location.href = authurl;
  } else if(!isEmpty(params.code)){
    // get openid from weixin
   var data = {'code':params.code};
  $(".ajaxform input[name='code']").attr("value", data);
  var action = base +"/@@token_ajax";
  $.post(action,data,function(res) {        
    if (!isEmpty(res.errcode)&&res.errcode===40029) {
       window.location.href = authurl;
       } else {
        $(".ajaxform input[name='openid']").attr("value", res.openid);
       }
    },'json');	
  } else{
  	var openid = params.openid;
  	$(".ajaxform input[name='openid']").attr("value", res.openid);
  }
   
 
  }

$(document).ready(function(){
	var base = $("#juankuan_workflow").attr('data-ajax-base');
	var authurl = base + $("#juankuan_workflow").attr('data-ajax-auth');
    init(authurl,base);
    $(".ajaxform button[name='ok']").on("click",function() {
	var aname = $(".ajaxform input[name='name']").val();
	var money = $(".ajaxform input[name='money']").val();
	if (isNaN(parseFloat(money)))  {
	    alert( "必须输入有效的数字,可以有两位小数" );
	    $(".ajaxform input[name='money']").focus();
		return false;
		}
	var project = $(".ajaxform .radio input:radio[name='project']:checked").val();
	var openid = $(".ajaxform input[name='openid']").val();
	var code = $(".ajaxform input[name='code']").val();
	var data = {'aname':aname,'fee':money,'did':project,'openid':openid,'code':code};
	$.post(base + "/@@pay_ajax",data,function(callback) {
      console.log(JSON.stringify(callback));
      function onBridgeReady(){
      WeixinJSBridge.invoke(
      'getBrandWCPayRequest', {
         "appId":callback.appId,     
         "timeStamp":callback.timeStamp,    
         "nonceStr":callback.nonceStr,     
         "package":callback.package,     
         "signType":callback.signType,     
         "paySign":callback.paySign
      },
      function(res){
      if(res.err_msg == "get_brand_wcpay_request:ok" ){

      	//var zhifu_result = "ok";
      	//$.post("http://weixin.315ok.org/@@successnotify",
      	//       {"result":zhifu_result},function(callback){  },'json');

      } 
   }); 
 }
if (typeof WeixinJSBridge == "undefined"){
   if( document.addEventListener ){
       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
    }
   else if (document.attachEvent){
       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
    }
   }
 else{
   onBridgeReady();
 }							
},'json');
		return false;
	});			
}
);		
	</script>	
	</metal:js> 
</body>
</html>
